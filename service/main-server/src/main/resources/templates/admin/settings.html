<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/fragments/layout :: head('설정')">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>
    <!-- 사이드바 -->
    <div th:replace="admin/fragments/layout :: sidebar" th:with="currentPage='settings'"></div>

    <!-- 메인 컨텐츠 -->
    <div class="content">
        <div class="dashboard-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">설정</h4>
        </div>

        <!-- 오류 메시지 표시 -->
        <div th:if="${errorMessage}" class="alert alert-danger mb-4" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span th:text="${errorMessage}">오류 메시지</span>
        </div>
        <div th:if="${successMessage}" class="alert alert-success mb-4" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span th:text="${successMessage}">성공 메시지</span>
        </div>

        <!-- 일반 사용자 -->
        <div class="card mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">일반 사용자</h5>
                <div class="batch-actions d-none" id="batchActionsRegular">
                    <span class="selected-count me-2">0개 선택됨</span>
                    <button class="btn btn-sm btn-warning" onclick="batchDisableAccounts('regular')" id="batchDisableRegular">
                        <i class="bi bi-person-x"></i> 선택 계정 비활성화
                    </button>
                    <button class="btn btn-sm btn-success" onclick="batchEnableAccounts('regular')" id="batchEnableRegular">
                        <i class="bi bi-person-check"></i> 선택 계정 활성화
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="batchLockAccounts('regular')" id="batchLockRegular">
                        <i class="bi bi-lock"></i> 선택 계정 잠금
                    </button>
                    <button class="btn btn-sm btn-info" onclick="batchUnlockAccounts('regular')" id="batchUnlockRegular">
                        <i class="bi bi-unlock"></i> 선택 계정 잠금 해제
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <div class="form-check">
                                        <input class="form-check-input select-all-regular" type="checkbox" id="selectAllRegular">
                                    </div>
                                </th>
                                <th>ID</th>
                                <th>이메일</th>
                                <th>이름</th>
                                <th>계정 만료일</th>
                                <th>비밀번호 만료일</th>
                                <th>상태</th>
                                <th>잠금</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${regularUsers == null || regularUsers.isEmpty()}">
                                <td colspan="9" class="text-center py-4 text-muted">
                                    등록된 일반 사용자가 없습니다.
                                </td>
                            </tr>
                            <tr th:each="user : ${regularUsers}">
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input user-checkbox-regular" type="checkbox" 
                                               th:value="${user.userId}" th:data-locked="${user.accountLocked}">
                                    </div>
                                </td>
                                <td th:text="${user.userId}">1</td>
                                <td th:text="${user.email}">user@example.com</td>
                                <td th:text="${user.name}">홍길동</td>
                                <td th:text="${#temporals.format(user.accountExpiredAt, 'yyyy-MM-dd HH:mm')}">-</td>
                                <td th:text="${#temporals.format(user.passwordExpiredAt, 'yyyy-MM-dd HH:mm')}">-</td>
                                <td>
                                    <span th:if="${user.enabled}" class="badge bg-success">활성</span>
                                    <span th:if="${user.enabled == false}" class="badge bg-secondary">비활성</span>
                                </td>
                                <td>
                                    <span th:if="${user.accountLocked == true}" class="badge bg-danger" data-bs-toggle="tooltip" title="계정이 잠금 상태입니다. 3분 후에 자동으로 잠금이 해제되거나 관리자가 수동으로 해제할 수 있습니다.">잠금</span>
                                    <span th:if="${user.accountLocked == false}" class="badge bg-success">정상</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" th:onclick="'extendAccountExpiry(' + ${user.userId} + ')'"><i class="bi bi-calendar-plus"></i> 계정 연장</button>
                                        <button class="btn btn-outline-info" th:onclick="'extendPasswordExpiry(' + ${user.userId} + ')'"><i class="bi bi-key"></i> 비번 연장</button>
                                        <button class="btn btn-outline-warning" th:if="${user.enabled}" th:onclick="'disableAccount(' + ${user.userId} + ')'"><i class="bi bi-person-x"></i> 비활성화</button>
                                        <button class="btn btn-outline-success" th:if="${user.enabled == false}" th:onclick="'enableAccount(' + ${user.userId} + ')'"><i class="bi bi-person-check"></i> 활성화</button>
                                        <button class="btn btn-outline-danger" th:if="${user.accountLocked == true}" th:onclick="'unlockAccount(' + ${user.userId} + ')'"><i class="bi bi-unlock"></i> 잠금 해제</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SNS 사용자 -->
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">SNS 사용자</h5>
                <div class="batch-actions d-none" id="batchActionsSns">
                    <span class="selected-count me-2">0개 선택됨</span>
                    <button class="btn btn-sm btn-warning" onclick="batchDisableAccounts('sns')" id="batchDisableSns">
                        <i class="bi bi-person-x"></i> 선택 계정 비활성화
                    </button>
                    <button class="btn btn-sm btn-success" onclick="batchEnableAccounts('sns')" id="batchEnableSns">
                        <i class="bi bi-person-check"></i> 선택 계정 활성화
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="batchLockAccounts('sns')" id="batchLockSns">
                        <i class="bi bi-lock"></i> 선택 계정 잠금
                    </button>
                    <button class="btn btn-sm btn-info" onclick="batchUnlockAccounts('sns')" id="batchUnlockSns">
                        <i class="bi bi-unlock"></i> 선택 계정 잠금 해제
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <div class="form-check">
                                        <input class="form-check-input select-all-sns" type="checkbox" id="selectAllSns">
                                    </div>
                                </th>
                                <th>ID</th>
                                <th>소셜 ID</th>
                                <th>제공자</th>
                                <th>이메일</th>
                                <th>이름</th>
                                <th>계정 만료일</th>
                                <th>비밀번호 만료일</th>
                                <th>상태</th>
                                <th>잠금</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${snsUsers == null || snsUsers.isEmpty()}">
                                <td colspan="11" class="text-center py-4 text-muted">
                                    등록된 SNS 사용자가 없습니다.
                                </td>
                            </tr>
                            <tr th:each="user : ${snsUsers}">
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input user-checkbox-sns" type="checkbox" 
                                               th:value="${user.id}" th:data-locked="${user.accountLocked}">
                                    </div>
                                </td>
                                <td th:text="${user.id}">1</td>
                                <td th:text="${user.socialId}">social_id</td>
                                <td th:text="${user.provider}">KAKAO</td>
                                <td th:text="${user.email}">user@example.com</td>
                                <td th:text="${user.name}">홍길동</td>
                                <td th:text="${#temporals.format(user.accountExpiredAt, 'yyyy-MM-dd HH:mm')}">-</td>
                                <td th:text="${#temporals.format(user.passwordExpiredAt, 'yyyy-MM-dd HH:mm')}">-</td>
                                <td>
                                    <span th:if="${user.enabled}" class="badge bg-success">활성</span>
                                    <span th:if="${user.enabled == false}" class="badge bg-secondary">비활성</span>
                                </td>
                                <td>
                                    <span th:if="${user.accountLocked == true}" class="badge bg-danger" data-bs-toggle="tooltip" title="계정이 잠금 상태입니다. 3분 후에 자동으로 잠금이 해제되거나 관리자가 수동으로 해제할 수 있습니다.">잠금</span>
                                    <span th:if="${user.accountLocked == false}" class="badge bg-success">정상</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" th:onclick="'extendAccountExpiry(' + ${user.id} + ')'"><i class="bi bi-calendar-plus"></i> 계정 연장</button>
                                        <button class="btn btn-outline-info" th:onclick="'extendPasswordExpiry(' + ${user.id} + ')'"><i class="bi bi-key"></i> 비번 연장</button>
                                        <button class="btn btn-outline-warning" th:if="${user.enabled}" th:onclick="'disableAccount(' + ${user.id} + ')'"><i class="bi bi-person-x"></i> 비활성화</button>
                                        <button class="btn btn-outline-success" th:if="${user.enabled == false}" th:onclick="'enableAccount(' + ${user.id} + ')'"><i class="bi bi-person-check"></i> 활성화</button>
                                        <button class="btn btn-outline-danger" th:if="${user.accountLocked == true}" th:onclick="'unlockAccount(' + ${user.id} + ')'"><i class="bi bi-unlock"></i> 잠금 해제</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="admin/fragments/layout :: scripts"></div>
    <script>
        // 툴팁 초기화
        $(document).ready(function() {
            $('[data-bs-toggle="tooltip"]').tooltip();
            
            // 전체 선택 체크박스 이벤트 처리
            $('#selectAllRegular').change(function() {
                $('.user-checkbox-regular').prop('checked', $(this).prop('checked'));
                updateBatchActionsVisibility('regular');
            });
            
            $('#selectAllSns').change(function() {
                $('.user-checkbox-sns').prop('checked', $(this).prop('checked'));
                updateBatchActionsVisibility('sns');
            });
            
            // 개별 체크박스 이벤트 처리
            $(document).on('change', '.user-checkbox-regular', function() {
                updateSelectAllCheckbox('regular');
                updateBatchActionsVisibility('regular');
            });
            
            $(document).on('change', '.user-checkbox-sns', function() {
                updateSelectAllCheckbox('sns');
                updateBatchActionsVisibility('sns');
            });
        });
        
        // 전체 선택 체크박스 상태 업데이트
        function updateSelectAllCheckbox(userType) {
            const checkboxClass = userType === 'regular' ? '.user-checkbox-regular' : '.user-checkbox-sns';
            const selectAllId = userType === 'regular' ? '#selectAllRegular' : '#selectAllSns';
            
            const totalCheckboxes = $(checkboxClass).length;
            const checkedCheckboxes = $(checkboxClass + ':checked').length;
            
            $(selectAllId).prop('checked', totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes);
        }
        
        // 일괄 작업 버튼 표시 여부 업데이트
        function updateBatchActionsVisibility(userType) {
            const checkboxClass = userType === 'regular' ? '.user-checkbox-regular' : '.user-checkbox-sns';
            const batchActionsId = userType === 'regular' ? '#batchActionsRegular' : '#batchActionsSns';
            const disableButtonId = userType === 'regular' ? '#batchDisableRegular' : '#batchDisableSns';
            const enableButtonId = userType === 'regular' ? '#batchEnableRegular' : '#batchEnableSns';
            const lockButtonId = userType === 'regular' ? '#batchLockRegular' : '#batchLockSns';
            const unlockButtonId = userType === 'regular' ? '#batchUnlockRegular' : '#batchUnlockSns';
            const checkedCheckboxes = $(checkboxClass + ':checked');
            const checkedCount = checkedCheckboxes.length;
            $(batchActionsId + ' .selected-count').text(checkedCount + '개 선택됨');
            $(batchActionsId).toggleClass('d-none', checkedCount === 0);
            let canDisable = false, canEnable = false, canLock = false, canUnlock = false;
            checkedCheckboxes.each(function() {
                const $row = $(this).closest('tr');
                const isEnabled = $row.find('.badge.bg-success').length > 0;
                const isDisabled = $row.find('.badge.bg-secondary').length > 0;
                const isLocked = $row.find('.badge.bg-danger').length > 0;
                if (isEnabled) canDisable = true;
                if (isDisabled) canEnable = true;
                if (!isLocked) canLock = true;
                if (isLocked) canUnlock = true;
            });
            $(disableButtonId).prop('disabled', !canDisable);
            $(enableButtonId).prop('disabled', !canEnable);
            $(lockButtonId).prop('disabled', !canLock);
            $(unlockButtonId).prop('disabled', !canUnlock);
        }
        
        // 일괄 계정 잠금
        function batchLockAccounts(userType) {
            const checkboxClass = userType === 'regular' ? '.user-checkbox-regular' : '.user-checkbox-sns';
            const userIds = [];
            
            $(checkboxClass + ':checked').each(function() {
                // 이미 잠금 상태가 아닌 계정만 선택
                if ($(this).data('locked') !== true) {
                    userIds.push($(this).val());
                }
            });
            
            if (userIds.length === 0) {
                showAlert('잠금할 계정을 선택해주세요.', false);
                return;
            }
            
            if (confirm(`선택한 ${userIds.length}개의 계정을 잠금 처리하시겠습니까?`)) {
                var csrfToken = $('meta[name="_csrf"]').attr('content');
                var csrfHeader = $('meta[name="_csrf_header"]').attr('content');
                $.ajax({
                    url: '/admin/api/users/batch/lock',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ userIds: userIds }),
                    beforeSend: function(xhr) {
                        if (csrfToken && csrfHeader) xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function(response) {
                        showAlert('선택한 계정이 잠금 처리되었습니다.', true);
                        setTimeout(() => location.reload(), 1000);
                    },
                    error: function(xhr) {
                        showAlert('계정 잠금 처리 중 오류가 발생했습니다.', false);
                    }
                });
            }
        }
        
        // 일괄 계정 잠금 해제
        function batchUnlockAccounts(userType) {
            const checkboxClass = userType === 'regular' ? '.user-checkbox-regular' : '.user-checkbox-sns';
            const userIds = [];
            
            $(checkboxClass + ':checked').each(function() {
                // 잠금 상태인 계정만 선택
                if ($(this).data('locked') === true) {
                    userIds.push($(this).val());
                }
            });
            
            if (userIds.length === 0) {
                showAlert('잠금 해제할 계정을 선택해주세요.', false);
                return;
            }
            
            if (confirm(`선택한 ${userIds.length}개의 계정 잠금을 해제하시겠습니까?`)) {
                var csrfToken = $('meta[name="_csrf"]').attr('content');
                var csrfHeader = $('meta[name="_csrf_header"]').attr('content');
                $.ajax({
                    url: '/admin/api/users/batch/unlock',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ userIds: userIds }),
                    beforeSend: function(xhr) {
                        if (csrfToken && csrfHeader) xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function(response) {
                        showAlert('선택한 계정의 잠금이 해제되었습니다.', true);
                        setTimeout(() => location.reload(), 1000);
                    },
                    error: function(xhr) {
                        showAlert('계정 잠금 해제 중 오류가 발생했습니다.', false);
                    }
                });
            }
        }

        function showAlert(msg, isSuccess) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert ' + (isSuccess ? 'alert-success' : 'alert-danger') + ' mt-3';
            alertDiv.innerHTML = msg;
            document.querySelector('.content').prepend(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }
        function ajaxAction(url, method, userId, successMsg) {
            fetch(url.replace('{userId}', userId), {
                method: method,
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => {
                if (res.ok) {
                    showAlert(successMsg, true);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    res.json().then(data => showAlert(data.msg || '실패했습니다.', false));
                }
            })
            .catch(() => showAlert('요청 중 오류가 발생했습니다.', false));
        }
        function extendAccountExpiry(userId) {
            ajaxAction('/admin/api/users/' + userId + '/extend-account', 'PUT', userId, '계정 만료일이 연장되었습니다.');
        }
        function extendPasswordExpiry(userId) {
            ajaxAction('/admin/api/users/' + userId + '/extend-password', 'PUT', userId, '비밀번호 만료일이 연장되었습니다.');
        }
        function disableAccount(userId) {
            ajaxAction('/admin/api/users/' + userId + '/disable', 'PUT', userId, '계정이 비활성화되었습니다.');
        }
        function enableAccount(userId) {
            ajaxAction('/admin/api/users/' + userId + '/enable', 'PUT', userId, '계정이 활성화되었습니다.');
        }
        function unlockAccount(userId) {
            // Redis 기반 계정 잠금: 3분 TTL로 자동 해제되며, 관리자가 수동으로 해제할 수도 있습니다.
            ajaxAction('/admin/api/users/' + userId + '/unlock', 'PUT', userId, '계정 잠금이 해제되었습니다.');
        }
        function batchDisableAccounts(userType) {
            const checkboxClass = userType === 'regular' ? '.user-checkbox-regular' : '.user-checkbox-sns';
            const userIds = [];
            $(checkboxClass + ':checked').each(function() {
                const $row = $(this).closest('tr');
                const isEnabled = $row.find('.badge.bg-success').length > 0;
                if (isEnabled) userIds.push($(this).val());
            });
            if (userIds.length === 0) return showAlert('비활성화할 계정을 선택하세요.', false);
            if (confirm(`${userIds.length}개 계정을 비활성화 하시겠습니까?`)) {
                var csrfToken = $('meta[name="_csrf"]').attr('content');
                var csrfHeader = $('meta[name="_csrf_header"]').attr('content');
                $.ajax({
                    url: '/admin/api/users/batch/disable',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(userIds),
                    beforeSend: function(xhr) {
                        if (csrfToken && csrfHeader) xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function() { location.reload(); },
                    error: function(xhr) { showAlert('비활성화 실패: ' + (xhr.responseJSON?.msg || ''), false); }
                });
            }
        }
        function batchEnableAccounts(userType) {
            const checkboxClass = userType === 'regular' ? '.user-checkbox-regular' : '.user-checkbox-sns';
            const userIds = [];
            $(checkboxClass + ':checked').each(function() {
                const $row = $(this).closest('tr');
                const isDisabled = $row.find('.badge.bg-secondary').length > 0;
                if (isDisabled) userIds.push($(this).val());
            });
            if (userIds.length === 0) return showAlert('활성화할 계정을 선택하세요.', false);
            if (confirm(`${userIds.length}개 계정을 활성화 하시겠습니까?`)) {
                var csrfToken = $('meta[name="_csrf"]').attr('content');
                var csrfHeader = $('meta[name="_csrf_header"]').attr('content');
                $.ajax({
                    url: '/admin/api/users/batch/enable',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(userIds),
                    beforeSend: function(xhr) {
                        if (csrfToken && csrfHeader) xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function() { location.reload(); },
                    error: function(xhr) { showAlert('활성화 실패: ' + (xhr.responseJSON?.msg || ''), false); }
                });
            }
        }
    </script>
</body>
</html> 